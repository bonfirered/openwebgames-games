<!doctype html>
<html lang="en-us">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>Unity WebGL Player | AngryBots</title>
		<link rel="stylesheet" href="TemplateData/style.css">
		<link rel="stylesheet" href="../styles.css">
		<link rel="shortcut icon" href="TemplateData/favicon.ico" />
		<script src="TemplateData/UnityProgress.js"></script>
	</head>
	<body class="template">
		<canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()" height="600px" width="938px"></canvas>
		<script src="../cpuprofiler.js"></script>
		<script src="config.js"></script>
		<script src="../emtimer.js"></script>
		<script src="inputstream.js"></script>
		<script src="Release/UnityConfig.js"></script>
		<script src="Release/fileloader.js"></script>
		<script>

		// angrybots game
		(function(){
			var key = 'angrybots';
			if (top.startGame) top.startGame(key);

			// @todo: call when done running game test
			//top.stopGame(key, results);
			if (!(!Math.fround)) {
				console.log('loading script');
				var script = document.createElement('script');
				script.src = "Release/2015-08-28-emunittest_0.4-AngryBots-u5.1.3f1_hg-e1.34.6-release-prof.js";
				document.body.appendChild(script);
			} else {
				console.log('loading xhr');
				var codeXHR = new XMLHttpRequest();
				codeXHR.open('GET', 'Release/2015-08-28-emunittest_0.4-AngryBots-u5.1.3f1_hg-e1.34.6-release-prof.js', true);
				codeXHR.onload = function(){
					console.log('xhr is loaded');
					var code = codeXHR.responseText;
					if (!Math.fround){
						try {
							console.log('optimizing out Math.fround calls');
							var m = /var ([^=]+)=global\.Math\.fround;/.exec(code);
							var minified = m[1];
							if (!minified)
								throw 'fail';
							var startAsm = code.indexOf('// EMSCRIPTEN_START_FUNCS');
							var endAsm = code.indexOf('// EMSCRIPTEN_END_FUNCS');
							var asm = code.substring(startAsm, endAsm);
							do {
								var moar = false; // we need to re-do, as x(x( will not be fixed
								asm = asm.replace(new RegExp('[^a-zA-Z0-9\\$\\_]' + minified + '\\(', 'g'), function(s) { moar = true; return s[0] + '(' });
							} while (moar);
							code = code.substring(0, startAsm) + asm + code.substring(endAsm);
							code = code.replace("'use asm'", "'almost asm'");
						} catch(e) {
							console.log('failed to optimize out Math.fround calls ' + e);
						}
					}
					var blob = new Blob([code], { type: 'text/javascript' });
					codeXHR = null;
					var src = URL.createObjectURL(blob);
					var script = document.createElement('script');
					script.src = URL.createObjectURL(blob);
					script.onload = function(){
						URL.revokeObjectURL(script.src);
					};
					document.body.appendChild(script);
				};
				codeXHR.send(null);

			}

		}());

		</script>
	</body>
</html>

